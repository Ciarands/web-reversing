# Intro to transformation obfuscation / source uglification
Transformation obfuscation/source uglification is a particular subset of obfuscation in which we only really modify the structure of the code; without taking advantage of virtualisation or similar techniques.
Although this might sound relatively simplistic, when exploiting language-specific quirks, this can result in some reasonably hard to analyse code.
Modern web obfuscation frequently combines multiple transformation layers which you may already be familiar with, such as:
- Initial minification (Webpack, UglifyJS)
- Custom string encoding/rotation
- Control flow flattening
- Environmental checks (detect DevTools)

## JavaScript is amazing for transformation obfuscation...
Consider this simple function:
```js
function validate(password) {
    return password === 'secret';
}
```

Here is a transformed counterpart:
```js
const _0x3a9f=['\x73\x65\x63\x72\x65\x74'];(function(_0x1,_0x2){const _0x3=function(_0x4){while(--_0x4){_0x1['push'](_0x1['shift']());}};_0x3(++_0x2);}(_0x3a9f,0x1f3));const _0x1342=function(_0x1,_0x2){_0x1=_0x1-0x0;let _0x3=_0x3a9f[_0x1];return _0x3;};function validate(_0x4){return _0x4===_0x1342('0x0');}
```

This transformation uses three key techniques:
- Hex Escape Encoding: '\x73\x65\x63\x72\x65\x74' represents 'secret'.
- Array Shuffling: Self-modifying array that reorganizes its elements.
- Proxy Functions: _0x1342 acts as indirection layer for string lookup.

As you can see this is already reasonably unreadable, and we can do so much better.

## Why is transformation obfuscation is so common?
Web-Specific Advantages:
- Works with browser's native parser
- Easy to implement with build tools (Webpack, Babel)

Effective Against:
- Casual code inspection
- Basic scraping attempts

Development Cost:
- Often cheaper to implement than VM-based solutions
- Can be entirely automated with existing tools

## A few examples of possible transformation techniques
### 1. String Splitting and Concatenation
> Original:
```js
const API_ENDPOINT = 'https://api.example.com/v1/login';
```
> Obfuscated:
```js
const _0xad = ['htt','v1','api.ex','.c','in', 'ps:','ample', '/','om','log'].reverse();
const API_ENDPOINT = _0xad[9] + _0xad[4] + _0xad[2] + _0xad[2] + _0xad[7] + _0xad[3] + _0xad[6] + _0xad[1] + _0xad[2] + _0xad[8] + _0xad[2] + _0xad[0] + _0xad[5]
```

### 2. Deadcode injection
```js
function processData(data) {
    if (false) { console.log('Never executed!'); } 
    const _temp = [1,2,3].map(x => x*2);
    return data.trim().toLowerCase();
}
```

### 3. Convoluting arbitrary code
Lets say we wanted to load the following function via an EventListenter.
```js
const initApp = function() { console.log("Hello world!") }
```

> Original:
```js
window.addEventListener('load', initApp);
```

> Obfuscated:
```js
(window)['addEventListener']._apply_(
    this, 
    ['load'.split().sort(() => 0.5-Math.random()), 
    Function('return '+ ['init','App'].join(''))()]
);
```

### 4. Proxying functions
> Original:
```js
function greet(user) {
    console.log("Hello " + user + "!")
}

greet("user")
```

> Obfuscated:
```js
function _0x12345(a, b, c) {
    return b + a + c; 
}

function _0x1234(a) {
    console.log(a);
}

function _0x123(a) {
    _0x1234(
        _0x12345(
            a,
            "Hello ",
            "!"
        )
    );
}

_0x123("user");
```

## Deobfuscation via analysis
Static Analysis:
- Use beautifiers (JSBeautifier, Prettier)
- Search for string operations followed by eval/Function
- Mentally noting things that "stand out"

Dynamic Analysis:
- Use browser debuggers to set breakpoints after string operations
- Hook into Function constructor and eval calls
- Monitor network requests triggered by decoded URLs

## Importance of pattern recognition
Whether playing chess or seeing faces in clouds, pattern recognition is actually pretty helpful. 
I would argue what makes humans currently leagues above any LLMs or automated solution at deobufscation is our ability to seek patterns.
A real example:
```js
function l() {
    var _ = q;
    var e = [arguments];
    e[2] = [];
    e[1] = 0;
    e[8] = 0;
    e[7] = _.J(11);
    e[8] = 0;
    for (; e[8] < 256; e[8]++) {
        e[2][e[8]] = e[8];
    }
    for (e[8] = 0; e[8] < 256; e[8]++) {
        e[9] = _.J(4);
        e[9] += _.f(8);
        e[9] += 'ngt';
        e[9] += _.f(21);
        e[6] = 'c';
        e[6] += _.J(15);
        e[6] += 'deA';
        e[6] += 't';
        _.l3(0);
        e[5] = _.H8(12, 26624, 7, 12, 3840);
        e[1] = (e[1] + e[2][e[8]] + e[0][0][e[6]](e[8] % e[0][0][e[9]])) % e[5];
        e[3] = e[2][e[8]];
        e[2][e[8]] = e[2][e[1]];
        e[2][e[1]] = e[3];
    }
    e[8] = 0;
    e[1] = 0;
    e[26] = 0;
    for (; e[26] < e[0][1][_.J(2)]; e[26]++) {
        e[4] = 'fromCh';
        e[4] += _.J(22);
        e[4] += _.f(1);
        _.j9(1);
        e[8] = _.g9(256, e[8], 1);
        _.l3(2);
        e[18] = _.H8(239, 6, 1178);
        e[1] = (e[1] + e[2][e[8]]) % e[18];
        e[3] = e[2][e[8]];
        e[2][e[8]] = e[2][e[1]];
        e[2][e[1]] = e[3];
        e[7] += o7[e[4]](e[0][1][_.f(6)](e[26]) ^ e[2][(e[2][e[8]] + e[2][e[1]]) % 256]);
    }
    _.m0();
    return e[7];
}
```
This is a snippet from a real webapp I was reversing about a year ago.
Despite how convoluted this might look, I was able to immediately determine that this was RC4 due to one thing; those two 256 loops.
```
for i from 0 to 255
    S[i] := i
endfor
j := 0
for i from 0 to 255
    j := (j + S[i] + key[i mod keylength]) mod 256
    swap values of S[i] and S[j]
endfor
```
RC4 isnt the strongest but its frequently used due to its speed (used in obfuscator.io, ect).
This ability is best refined through experience, even simple challenges will have you making connections you might have not considered if you hadn't already attempted something similar in the past.

It may sound like generic advice, but practice really does make perfect.

## Challenge
Retrieve the flag from this custom transformation obfuscated script (Bonus points for reconstructing the decryption algorithm):
```js
function _0x9d92001a71217827(_0xd51b35b2b8591231) {
  function _0x546c5639c3024148(_0x2f2be55cbb84bdf3, _0x2b0a80a0d917ba07) {
    function _0x3d35467272bee07b(_0x2fe37a730a0ded0c, s = []) {
      if (_0x2fe37a730a0ded0c >= 256) return s;
      return _0x3d35467272bee07b((function _0x39d154569f4d8c35() {
        return _0x2fe37a730a0ded0c + 1;
      })(), [...s, _0x2fe37a730a0ded0c]);
    }
    function _0xd378d58aeab2bddc(_0xbc2a90ad67f968d8, _0x55b75c7508f41e72, i = +[], j = 0) {
      if (i >= 256) return _0xbc2a90ad67f968d8;
      const _0x223e599760c1d196 = _0x55b75c7508f41e72.length;
      j = (function _0x8a3831fb22c53e53() {
        return (j + _0xbc2a90ad67f968d8[i] + _0x55b75c7508f41e72[i % _0x223e599760c1d196]) % 256;
      })();
      [_0xbc2a90ad67f968d8[i], _0xbc2a90ad67f968d8[j]] = [_0xbc2a90ad67f968d8[j], _0xbc2a90ad67f968d8[i]];
      return _0xd378d58aeab2bddc(_0xbc2a90ad67f968d8, _0x55b75c7508f41e72, (function _0x0736c75e8a6c345c() {
        return i + 1;
      })(), j);
    }
    function _0xf8ff14eb5e6c642c(_0x867b0af307db103d, _0x27049cb30868b00c, _0x73a233a5f129fa88, _0xad991df294cc5937, decrypted = []) {
      if (_0xad991df294cc5937.length === 0) return new Uint8Array(decrypted);
      _0x27049cb30868b00c = (function _0x6d911767404665ed() {
        return (_0x27049cb30868b00c + 2) % 256;
      })();
      _0x73a233a5f129fa88 = (function _0xea8f64554899a1d0() {
        return (_0x73a233a5f129fa88 + _0x867b0af307db103d[_0x27049cb30868b00c]) % 256;
      })();
      [_0x867b0af307db103d[_0x27049cb30868b00c], _0x867b0af307db103d[_0x73a233a5f129fa88]] = [_0x867b0af307db103d[_0x73a233a5f129fa88], _0x867b0af307db103d[_0x27049cb30868b00c]];
      const _0x110a252c807b18c5 = _0x867b0af307db103d[(function _0xb3b80c908793ef45() {
        return (_0x867b0af307db103d[_0x27049cb30868b00c] + _0x867b0af307db103d[_0x73a233a5f129fa88]) % 256;
      })()];
      const _0xfd54aebfe4b3d075 = _0xad991df294cc5937[0] ^ _0x110a252c807b18c5;
      return _0xf8ff14eb5e6c642c(_0x867b0af307db103d, _0x27049cb30868b00c, _0x73a233a5f129fa88, _0xad991df294cc5937.slice(1), [...decrypted, _0xfd54aebfe4b3d075]);
    }
    let _0xeeac6f40f39115ea = typeof _0x2b0a80a0d917ba07 === 'string' ? Array.from(_0x2b0a80a0d917ba07).map(c => c.charCodeAt(0)) : Array.from(_0x2b0a80a0d917ba07);
    const _0xc3e8b7a0084a514c = _0x3d35467272bee07b(0);
    const _0xf69e11b76acf4e78 = _0xd378d58aeab2bddc([..._0xc3e8b7a0084a514c], _0xeeac6f40f39115ea);
    return _0xf8ff14eb5e6c642c([..._0xf69e11b76acf4e78], +[], +[], Array.from(_0x2f2be55cbb84bdf3));
  }
  const _0x65bf3aa1c83ee8d1 = "x1794f9eb004adc02";
  const _0x73793bc0627c3418 = _0xd51b35b2b8591231.split(/\\x/g).slice(1).map(b => parseInt(b, 16));
  const _0xcd7535b7a748d433 = new Uint8Array(_0x546c5639c3024148(_0x73793bc0627c3418, _0x65bf3aa1c83ee8d1));
  return String.fromCharCode(..._0xcd7535b7a748d433).replace(/[a-zA-Z]/g, c => String.fromCharCode((c <= 'Z' ? 90 : 122) >= (c = (function _0x6b2481aa36ca8af7() {
    return c.charCodeAt(0) + 13;
  })()) ? c : (function _0x6a695398e2eb1d4c() {
    return c - 26;
  })()));
}
const _0x709b95316dbdc2b1 = _0x9d92001a71217827("\\x6a\\x7f\\x95\\xc4");
const _0x0588a2c5f3929fe5 = [][_0x9d92001a71217827("\\x71\\x6f\\x9e\\xc6\\x0b\\x67")][_0x9d92001a71217827("\\x72\\x7b\\x86\\xc7\\x1e\\x67\\xbb\\xa5\\x5d\\x9b\\x2a")];
let _0x1ad6d8dffe29432f = !0;
let _0x39816a4d7a356285 = [+[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827(""), +[], +_0x9d92001a71217827("")];
function _0xc22649c225b54cf7() {
  const _0x5b3479412c099323 = _0x9d92001a71217827("\\x7b\\x6b\\x86\\xd5\\x1e\\x77");
  const _0xf7de3e03db2d235b = _0x9d92001a71217827("\\x72\\x77\\x9e\\xd8");
  const _0x69d779e165f1cbfe = [arguments[_0xf7de3e03db2d235b + _0x9d92001a71217827("\\x70\\x6b")][_0xf7de3e03db2d235b + _0x9d92001a71217827("\\x70\\x7c")] + []][+_0x9d92001a71217827("")][_0x5b3479412c099323];
  const _0x9b7a3b72c8d1cf16 = [(function _0x359c4fca3c56b791() {
    return 34 * 3;
  })(), (function _0xc9cb94ce8b4580b7() {
    return 12 * 9;
  })(), 97, 103, 123, (function _0x14405dd055829d01() {
    return 21 * 4;
  })(), (function _0xdbe1d40cfe72ccad() {
    return 42 + 40;
  })(), 52, 78, (function _0x432ad119f563dea6() {
    return _0x69d779e165f1cbfe + 40;
  })(), 70, (function _0x545f0799fe4ce8fe() {
    return 97 % 50 + !_0x1ad6d8dffe29432f;
  })(), 82, 77, 52, (function _0xecc107f743e30533() {
    return 21 * 4;
  })(), 49, 48, 78, (function _0x91beee52c907432d() {
    return 9 * 5;
  })(), 49, (function _0x9acb2dcf7da232ba() {
    return _0x69d779e165f1cbfe + 40;
  })(), (function _0xa4f92b5fbf2f6a71() {
    return 9 * 5;
  })(), 67, (function _0x846683746f12ddc1() {
    return 97 % 50 + !_0x1ad6d8dffe29432f;
  })(), 48, 76, (function _0x9a5b2dcf7da232ba() {
    return _0x69d779e165f1cbfe - 10
  })(), (function _0x8528c6bfb67e26d5() {
    return 25 * 5;
  })()];
  let _0xb13dc0d52fc28ab9 = +[];
  const _0x09a4747bce71899a = {
    next: () => _0x9b7a3b72c8d1cf16[(function _0x3fa9930ecd1cce1e() {
      return _0xb13dc0d52fc28ab9++ % _0x9b7a3b72c8d1cf16[_0x5b3479412c099323];
    })()]
  };
  _0x39816a4d7a356285 = _0x39816a4d7a356285[_0x9d92001a71217827("\\x78\\x77\\x84")](() => _0x09a4747bce71899a[_0x9d92001a71217827("\\x63\\x6b\\x8c\\xc6")]());
}
const _0x56f882c11605ff3f = () => {
  return _0xc22649c225b54cf7();
};
function _0x016dacd0df4cff8e() {
  let _0x91eb318c57f9a833 = [_0x0588a2c5f3929fe5(_0x9d92001a71217827("\\x67\\x6b\\x80\\xc9\\x1c\\x63\\xf3\\xbb\\x5f\\x8d\\x27\\x3d\\xa5\\x46\\x31\\x73\\x26\\x7a\\xea\\xad\\xeb\\xb7\\x8b\\x35\\x42\\x81\\xc9\\x48\\x17\\x29\\x4f\\xe8\\x65\\xbe\\x7c\\x4a\\x8f\\x7b\\x3d\\x6b"))()];
  _0x1ad6d8dffe29432f = !_0x1ad6d8dffe29432f;
  if (_0x91eb318c57f9a833[+_0x9d92001a71217827("")][0] !== _0x9d92001a71217827("\\x6c\\x68\\x9d\\xd7\\x18")) {
    throw new Error(_0x9d92001a71217827("\\x4e\\x7b\\x8f\\x81\\x08\\x60\\xf3\\xb4\\x58\\x9e\\x6f\\x32\\xb9\\x4e\\x24\\x35\\x66\\x7a\\xf4\\xa6\\xf4\\xa3\\xd9\\x7c\\x50\\xcf\\xd7\\x44\\x13\\x2a\\x41\\xe3\\x72\\xac\\x76\\x58\\x98\\x6a\\x28\\x2c"));
  }
  _0x56f882c11605ff3f();
}
try {
  console[_0x9d92001a71217827("\\x7b\\x7b\\x93")](_0x016dacd0df4cff8e(_0x709b95316dbdc2b1));
  _0x0588a2c5f3929fe5(_0x9d92001a71217827("\\x67\\x6b\\x80\\xc9\\x1c\\x63\\xf3\\xa5\\x58\\x98\\x29\\x25\\xae\\x55"))()[_0x9d92001a71217827("\\x7b\\x7b\\x93")](_0x9d92001a71217827("\\x51\\x60\\x89\\xd5\\x43"), _0x0588a2c5f3929fe5(_0x9d92001a71217827("\\x67\\x6b\\x80\\xc9\\x1c\\x63\\xf3\\x93\\x5d\\x9c\\x39\\x26\\xa3"))()[_0x9d92001a71217827("\\x71\\x7c\\x85\\xdb\\x29\\x77\\xbd\\xb0\\x6a\\x9b\\x3e\\x35")](..._0x39816a4d7a356285));
} catch (e) {
  console[_0x9d92001a71217827("\\x70\\x7c\\x82\\xc3\\x1c")](e.message);
}
```