# Intro to transformation obfuscation / source uglification
Transformation obfuscation/source uglification is a particular subset of obfuscation in which we only really modify the structure of the code; without taking advantage of virtualisation or similar techniques.
Although this might sound relatively simplistic, when exploiting language-specific quirks, this can result in some reasonably hard to analyse code.
Modern web obfuscation frequently combines multiple transformation layers which you may already be familiar with, such as:
    - Initial minification (Webpack, UglifyJS)
    - Custom string encoding/rotation
    - Control flow flattening
    - Environmental checks (detect DevTools)

## JavaScript is amazing for transformation obfuscation...
Consider this simple function:
```js
function validate(password) {
    return password === 'secret';
}
```

Here is a transformed counterpart:
```js
const _0x3a9f=['\x73\x65\x63\x72\x65\x74'];(function(_0x1,_0x2){const _0x3=function(_0x4){while(--_0x4){_0x1['push'](_0x1['shift']());}};_0x3(++_0x2);}(_0x3a9f,0x1f3));const _0x1342=function(_0x1,_0x2){_0x1=_0x1-0x0;let _0x3=_0x3a9f[_0x1];return _0x3;};function validate(_0x4){return _0x4===_0x1342('0x0');}
```

This transformation uses three key techniques:
- Hex Escape Encoding: '\x73\x65\x63\x72\x65\x74' represents 'secret'.
- Array Shuffling: Self-modifying array that reorganizes its elements.
- Proxy Functions: _0x1342 acts as indirection layer for string lookup.

As you can see this is already reasonably unreadable, and we can do so much better.

## Why is transformation obfuscation is so common?
Web-Specific Advantages:
- Works with browser's native parser
- Easy to implement with build tools (Webpack, Babel)

Effective Against:
- Casual code inspection
- Basic scraping attempts

Development Cost:
- Often cheaper to implement than VM-based solutions
- Can be entirely automated with existing tools

## A few examples of possible transformation techniques
### 1. String Splitting and Concatenation
> Original:
```js
const API_ENDPOINT = 'https://api.example.com/v1/login';
```
> Obfuscated:
```js
const _0xad = ['htt','v1','api.ex','.c','in', 'ps:','ample', '/','om','log'].reverse();
const API_ENDPOINT = _0xad[9] + _0xad[4] + _0xad[2] + _0xad[2] + _0xad[7] + _0xad[3] + _0xad[6] + _0xad[1] + _0xad[2] + _0xad[8] + _0xad[2] + _0xad[0] + _0xad[5]
```

### 2. Deadcode injection
```js
function processData(data) {
    if (false) { console.log('Never executed!'); } 
    const _temp = [1,2,3].map(x => x*2);
    return data.trim().toLowerCase();
}
```

### 3. Convoluting arbitrary code
Lets say we wanted to load the following function via an EventListenter.
```js
const initApp = function() { console.log("Hello world!") }
```

> Original:
```js
window.addEventListener('load', initApp);
```

> Obfuscated:
```js
(window)['addEventListener']._apply_(
    this, 
    ['load'.split().sort(() => 0.5-Math.random()), 
    Function('return '+ ['init','App'].join(''))()]
);
```

### 4. Proxying functions
> Original:
```js
function greet(user) {
    console.log("Hello " + user + "!")
}

greet("user")
```

> Obfuscated:
```js
function _0x12345(a, b, c) {
    return b + a + c; 
}

function _0x1234(a) {
    console.log(a);
}

function _0x123(a) {
    _0x1234(
        _0x12345(
            a,
            "Hello ",
            "!"
        )
    );
}

_0x123("user");
```

## Deobfuscation via analysis
Static Analysis:
- Use beautifiers (JSBeautifier, Prettier)
- Search for string operations followed by eval/Function
- Mentally noting things that "stand out"

Dynamic Analysis:
- Use browser debuggers to set breakpoints after string operations
- Hook into Function constructor and eval calls
- Monitor network requests triggered by decoded URLs

## Importance of pattern recognition
Whether playing chess or seeing faces in clouds, pattern recognition is actually pretty helpful. 
I would argue what makes humans currently leagues above any LLMs or automated solution at deobufscation is our ability to seek patterns.
A real example:
```js
function l() {
    var _ = q;
    var e = [arguments];
    e[2] = [];
    e[1] = 0;
    e[8] = 0;
    e[7] = _.J(11);
    e[8] = 0;
    for (; e[8] < 256; e[8]++) {
        e[2][e[8]] = e[8];
    }
    for (e[8] = 0; e[8] < 256; e[8]++) {
        e[9] = _.J(4);
        e[9] += _.f(8);
        e[9] += 'ngt';
        e[9] += _.f(21);
        e[6] = 'c';
        e[6] += _.J(15);
        e[6] += 'deA';
        e[6] += 't';
        _.l3(0);
        e[5] = _.H8(12, 26624, 7, 12, 3840);
        e[1] = (e[1] + e[2][e[8]] + e[0][0][e[6]](e[8] % e[0][0][e[9]])) % e[5];
        e[3] = e[2][e[8]];
        e[2][e[8]] = e[2][e[1]];
        e[2][e[1]] = e[3];
    }
    e[8] = 0;
    e[1] = 0;
    e[26] = 0;
    for (; e[26] < e[0][1][_.J(2)]; e[26]++) {
        e[4] = 'fromCh';
        e[4] += _.J(22);
        e[4] += _.f(1);
        _.j9(1);
        e[8] = _.g9(256, e[8], 1);
        _.l3(2);
        e[18] = _.H8(239, 6, 1178);
        e[1] = (e[1] + e[2][e[8]]) % e[18];
        e[3] = e[2][e[8]];
        e[2][e[8]] = e[2][e[1]];
        e[2][e[1]] = e[3];
        e[7] += o7[e[4]](e[0][1][_.f(6)](e[26]) ^ e[2][(e[2][e[8]] + e[2][e[1]]) % 256]);
    }
    _.m0();
    return e[7];
}
```
This is a snippet from a real webapp I was reversing about a year ago.
Despite how convoluted this might look, I was able to immediately determine that this was RC4 due to one thing; those two 256 loops.
```
for i from 0 to 255
    S[i] := i
endfor
j := 0
for i from 0 to 255
    j := (j + S[i] + key[i mod keylength]) mod 256
    swap values of S[i] and S[j]
endfor
```
RC4 isnt the strongest but its frequently used due to its speed (used in obfuscator.io, ect).
This ability is best refined through experience, even simple challenges will have you making connections you might have not considered if you hadn't already attempted something similar in the past.

It may sound like generic advice, but practice really does make perfect.

## Challenge
Retrieve the flag from this custom transformation obfuscated script (Bonus points for reconstructing the decryption algorithm):
```js
function _0x79157ec5312330c4(_0x43014f3b5c358f63) {
  function _0x9552e15e4f1038dc(_0x51091d0e59db13c7, _0xf87b32780f7160c3) {
    function _0x778295bd123de127(_0x7e98b9e21df92f6a, s = []) {
      if (_0x7e98b9e21df92f6a >= 256) return s;
      return _0x778295bd123de127((function _0x86f83b1f8a970182() {
        return _0x7e98b9e21df92f6a + 1;
      })(), [...s, _0x7e98b9e21df92f6a]);
    }
    function _0xad1108aa5f18aec0(_0x00107857053bb4a4, _0x9be01e6da27f1e0f, i = +[], j = 0) {
      if (i >= 256) return _0x00107857053bb4a4;
      const _0x0246b733ebc7293a = _0x9be01e6da27f1e0f.length;
      j = (function _0xe64874ff9d92e9b6() {
        return (j + _0x00107857053bb4a4[i] + _0x9be01e6da27f1e0f[i % _0x0246b733ebc7293a]) % 256;
      })();
      [_0x00107857053bb4a4[i], _0x00107857053bb4a4[j]] = [_0x00107857053bb4a4[j], _0x00107857053bb4a4[i]];
      return _0xad1108aa5f18aec0(_0x00107857053bb4a4, _0x9be01e6da27f1e0f, (function _0xcf014e56d2269b9a() {
        return i + 1;
      })(), j);
    }
    function _0x6aaa2687a4f1a75e(_0x91f60e687fb960d5, _0x6da8b12d3a83b534, _0x62411b3c68652eb5, _0xf2288ffb195934be, decrypted = []) {
      if (_0xf2288ffb195934be.length === 0) return new Uint8Array(decrypted);
      _0x6da8b12d3a83b534 = (function _0xd6b1868d1d6faa8a() {
        return (_0x6da8b12d3a83b534 + 2) % 256;
      })();
      _0x62411b3c68652eb5 = (function _0x0b94905ead04ec80() {
        return (_0x62411b3c68652eb5 + _0x91f60e687fb960d5[_0x6da8b12d3a83b534]) % 256;
      })();
      [_0x91f60e687fb960d5[_0x6da8b12d3a83b534], _0x91f60e687fb960d5[_0x62411b3c68652eb5]] = [_0x91f60e687fb960d5[_0x62411b3c68652eb5], _0x91f60e687fb960d5[_0x6da8b12d3a83b534]];
      const _0x0ed9eba75efdc279 = _0x91f60e687fb960d5[(function _0xd6dbcba7bda5812d() {
        return (_0x91f60e687fb960d5[_0x6da8b12d3a83b534] + _0x91f60e687fb960d5[_0x62411b3c68652eb5]) % 256;
      })()];
      const _0x7f20994e96408c03 = _0xf2288ffb195934be[0] ^ _0x0ed9eba75efdc279;
      return _0x6aaa2687a4f1a75e(_0x91f60e687fb960d5, _0x6da8b12d3a83b534, _0x62411b3c68652eb5, _0xf2288ffb195934be.slice(1), [...decrypted, _0x7f20994e96408c03]);
    }
    let _0x9c11706b860c761e = typeof _0xf87b32780f7160c3 === 'string' ? Array.from(_0xf87b32780f7160c3).map(c => c.charCodeAt(0)) : Array.from(_0xf87b32780f7160c3);
    const _0x6ef1b31b5e0fc0ba = _0x778295bd123de127(0);
    const _0x48ae1774d7f674d7 = _0xad1108aa5f18aec0([..._0x6ef1b31b5e0fc0ba], _0x9c11706b860c761e);
    return _0x6aaa2687a4f1a75e([..._0x48ae1774d7f674d7], +[], +[], Array.from(_0x51091d0e59db13c7));
  }
  const _0xd2bc27e9ab86bfc0 = "xcc3452ad5464778f";
  const _0xc79eecbbbeeae5b2 = _0x43014f3b5c358f63.split(/\\x/g).slice(1).map(b => parseInt(b, 16));
  const _0xbceba153cbad55b4 = new Uint8Array(_0x9552e15e4f1038dc(_0xc79eecbbbeeae5b2, _0xd2bc27e9ab86bfc0));
  return String.fromCharCode(..._0xbceba153cbad55b4).replace(/[a-zA-Z]/g, c => String.fromCharCode((c <= 'Z' ? 90 : 122) >= (c = (function _0x2ce2eaafd98e69ae() {
    return c.charCodeAt(0) + 13;
  })()) ? c : (function _0x9a199814cd9b2388() {
    return c - 26;
  })()));
}
const _0xfa2e6e4f068b0b23 = _0x79157ec5312330c4("\\x3a\\x2f\\x9a\\xbd");
let _0xae249b305f49a5f1 = [+[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[], +_0x79157ec5312330c4(""), +[]];
function _0xb01e69c8b24585a5() {
  const _0x7ffb88c3e87ffcda = [(function _0x2bd14dc89a01af3e() {
    return 34 * 3;
  })(), (function _0x9da4bd9301e108c8() {
    return 12 * 9;
  })(), 97, 103, 123, (function _0xc1d2b4ef0e71715f() {
    return 21 * 4;
  })(), (function _0xd8d06109519b222d() {
    return 42 + 40;
  })(), 52, 78, 83, 70, (function _0x618418f116324a8f() {
    return 97 % 50 + 1;
  })(), 82, 77, 52, (function _0x3a1f730668758a17() {
    return 21 * 4;
  })(), 49, 48, 78, (function _0x10293297d7b19d33() {
    return 9 * 5;
  })(), 49, 83, (function _0xe9df7387af3a09a2() {
    return 9 * 5;
  })(), 67, (function _0xc7fb347c0758752c() {
    return 97 % 50 + 1;
  })(), 48, 76, (function _0x5457eef4e03d04ab() {
    return 25 * 5;
  })()];
  let _0x6d8a4bfcfa56d899 = +[];
  let _0x978da95cf56af6a8 = _0x79157ec5312330c4("\\x2b\\x3b\\x89\\xac\\xd9\\xf3");
  const _0x7fa6030be1c5fb85 = {
    next: () => _0x7ffb88c3e87ffcda[(function _0x5cc08569b59c9427() {
      return _0x6d8a4bfcfa56d899++ % _0x7ffb88c3e87ffcda[_0x978da95cf56af6a8];
    })()]
  };
  _0xae249b305f49a5f1 = _0xae249b305f49a5f1[_0x79157ec5312330c4("\\x28\\x27\\x8b")](() => _0x7fa6030be1c5fb85[_0x79157ec5312330c4("\\x33\\x3b\\x83\\xbf")]());
}
const _0x979df169aea64a6a = () => {
  return _0xb01e69c8b24585a5();
};
function _0xbc0830ee843b2328() {
  let _0xa7cdcd18ae243f28 = [[][_0x79157ec5312330c4("\\x21\\x3f\\x91\\xbf\\xcc\\xe3")][_0x79157ec5312330c4("\\x22\\x2b\\x89\\xbe\\xd9\\xe3\\xf0\\x5e\\x06\\xa0\\x53")](_0x79157ec5312330c4("\\x37\\x3b\\x8f\\xb0\\xdb\\xe7\\xb8\\x40\\x04\\xb6\\x5e\\xd4\\x1b\\xcc\\x63\\x6c\\x0d\\x52\\x4d\\x3f\\xee\\x21\\xb7\\x9e\\x29\\xe6\\xff\\x0f\\xb2\\x5e\\x15\\xa6\\xf7\\xbc\\x4d\\x2f\\x72\\x26\\x33\\xf3"))()];
  if (_0xa7cdcd18ae243f28[+_0x79157ec5312330c4("")][0] !== _0x79157ec5312330c4("\\x3c\\x38\\x92\\xae\\xdf")) {
    return _0x79157ec5312330c4("\\x1e\\x2b\\x80\\xf8\\xcf\\xe4\\xb8\\x4f\\x03\\xa5\\x16\\xdb\\x07\\xc4\\x76\\x2a\\x4d\\x52\\x53\\x34\\xf1\\x35\\xe5\\xd7\\x3b\\xa8\\xe1\\x03\\xb6\\x5d\\x1b\\xad\\xe0\\xae\\x47\\x3d\\x65\\x37\\x26\\xb4\\x4c\\xaf");
  }
  _0x979df169aea64a6a();
}
_0xbc0830ee843b2328(_0xfa2e6e4f068b0b23);
[][_0x79157ec5312330c4("\\x21\\x3f\\x91\\xbf\\xcc\\xe3")][_0x79157ec5312330c4("\\x22\\x2b\\x89\\xbe\\xd9\\xe3\\xf0\\x5e\\x06\\xa0\\x53")](_0x79157ec5312330c4("\\x37\\x3b\\x8f\\xb0\\xdb\\xe7\\xb8\\x5e\\x03\\xa3\\x50\\xcc\\x10\\xdf"))()[_0x79157ec5312330c4("\\x2b\\x2b\\x9c")](_0x79157ec5312330c4("\\x01\\x30\\x86\\xac\\x84"), String.fromCharCode(..._0xae249b305f49a5f1));
```