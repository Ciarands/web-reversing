# Intro to transformation obfuscation / source uglification
Transformation obfuscation/source uglification is a particular subset of obfuscation in which we only really modify the structure of the code; without taking advantage of virtualisation or similar techniques.
Although this might sound relatively simplistic, when exploiting language-specific quirks, this can result in some reasonably hard to analyse code.
Modern web obfuscation frequently combines multiple transformation layers which you may already be familiar with, such as:
- Initial minification (Webpack, UglifyJS)
- Custom string encoding/rotation
- Control flow flattening
- Environmental checks (detect DevTools)

## JavaScript is amazing for transformation obfuscation...
Consider this simple function:
```js
function validate(password) {
    return password === 'secret';
}
```

Here is a transformed counterpart:
```js
const _0x3a9f=['\x73\x65\x63\x72\x65\x74'];(function(_0x1,_0x2){const _0x3=function(_0x4){while(--_0x4){_0x1['push'](_0x1['shift']());}};_0x3(++_0x2);}(_0x3a9f,0x1f3));const _0x1342=function(_0x1,_0x2){_0x1=_0x1-0x0;let _0x3=_0x3a9f[_0x1];return _0x3;};function validate(_0x4){return _0x4===_0x1342('0x0');}
```

This transformation uses three key techniques:
- Hex Escape Encoding: '\x73\x65\x63\x72\x65\x74' represents 'secret'.
- Array Shuffling: Self-modifying array that reorganizes its elements.
- Proxy Functions: _0x1342 acts as indirection layer for string lookup.

As you can see this is already reasonably unreadable, and we can do so much better.

## Why is transformation obfuscation is so common?
Web-Specific Advantages:
- Works with browser's native parser
- Easy to implement with build tools (Webpack, Babel)

Effective Against:
- Casual code inspection
- Basic scraping attempts

Development Cost:
- Often cheaper to implement than VM-based solutions
- Can be entirely automated with existing tools

## A few examples of possible transformation techniques
### 1. String Splitting and Concatenation
> Original:
```js
const API_ENDPOINT = 'https://api.example.com/v1/login';
```
> Obfuscated:
```js
const _0xad = ['htt','v1','api.ex','.c','in', 'ps:','ample', '/','om','log'].reverse();
const API_ENDPOINT = _0xad[9] + _0xad[4] + _0xad[2] + _0xad[2] + _0xad[7] + _0xad[3] + _0xad[6] + _0xad[1] + _0xad[2] + _0xad[8] + _0xad[2] + _0xad[0] + _0xad[5]
```

### 2. Deadcode injection
```js
function processData(data) {
    if (false) { console.log('Never executed!'); } 
    const _temp = [1,2,3].map(x => x*2);
    return data.trim().toLowerCase();
}
```

### 3. Convoluting arbitrary code
Lets say we wanted to load the following function via an EventListenter.
```js
const initApp = function() { console.log("Hello world!") }
```

> Original:
```js
window.addEventListener('load', initApp);
```

> Obfuscated:
```js
(window)['addEventListener']._apply_(
    this, 
    ['load'.split().sort(() => 0.5-Math.random()), 
    Function('return '+ ['init','App'].join(''))()]
);
```

### 4. Proxying functions
> Original:
```js
function greet(user) {
    console.log("Hello " + user + "!")
}

greet("user")
```

> Obfuscated:
```js
function _0x12345(a, b, c) {
    return b + a + c; 
}

function _0x1234(a) {
    console.log(a);
}

function _0x123(a) {
    _0x1234(
        _0x12345(
            a,
            "Hello ",
            "!"
        )
    );
}

_0x123("user");
```

## Deobfuscation via analysis
Static Analysis:
- Use beautifiers (JSBeautifier, Prettier)
- Search for string operations followed by eval/Function
- Mentally noting things that "stand out"

Dynamic Analysis:
- Use browser debuggers to set breakpoints after string operations
- Hook into Function constructor and eval calls
- Monitor network requests triggered by decoded URLs

## Importance of pattern recognition
Whether playing chess or seeing faces in clouds, pattern recognition is actually pretty helpful. 
I would argue what makes humans currently leagues above any LLMs or automated solution at deobufscation is our ability to seek patterns.
A real example:
```js
function l() {
    var _ = q;
    var e = [arguments];
    e[2] = [];
    e[1] = 0;
    e[8] = 0;
    e[7] = _.J(11);
    e[8] = 0;
    for (; e[8] < 256; e[8]++) {
        e[2][e[8]] = e[8];
    }
    for (e[8] = 0; e[8] < 256; e[8]++) {
        e[9] = _.J(4);
        e[9] += _.f(8);
        e[9] += 'ngt';
        e[9] += _.f(21);
        e[6] = 'c';
        e[6] += _.J(15);
        e[6] += 'deA';
        e[6] += 't';
        _.l3(0);
        e[5] = _.H8(12, 26624, 7, 12, 3840);
        e[1] = (e[1] + e[2][e[8]] + e[0][0][e[6]](e[8] % e[0][0][e[9]])) % e[5];
        e[3] = e[2][e[8]];
        e[2][e[8]] = e[2][e[1]];
        e[2][e[1]] = e[3];
    }
    e[8] = 0;
    e[1] = 0;
    e[26] = 0;
    for (; e[26] < e[0][1][_.J(2)]; e[26]++) {
        e[4] = 'fromCh';
        e[4] += _.J(22);
        e[4] += _.f(1);
        _.j9(1);
        e[8] = _.g9(256, e[8], 1);
        _.l3(2);
        e[18] = _.H8(239, 6, 1178);
        e[1] = (e[1] + e[2][e[8]]) % e[18];
        e[3] = e[2][e[8]];
        e[2][e[8]] = e[2][e[1]];
        e[2][e[1]] = e[3];
        e[7] += o7[e[4]](e[0][1][_.f(6)](e[26]) ^ e[2][(e[2][e[8]] + e[2][e[1]]) % 256]);
    }
    _.m0();
    return e[7];
}
```
This is a snippet from a real webapp I was reversing about a year ago.
Despite how convoluted this might look, I was able to immediately determine that this was RC4 due to one thing; those two 256 loops.
```
for i from 0 to 255
    S[i] := i
endfor
j := 0
for i from 0 to 255
    j := (j + S[i] + key[i mod keylength]) mod 256
    swap values of S[i] and S[j]
endfor
```
RC4 isnt the strongest but its frequently used due to its speed (used in obfuscator.io, ect).
This ability is best refined through experience, even simple challenges will have you making connections you might have not considered if you hadn't already attempted something similar in the past.

It may sound like generic advice, but practice really does make perfect.

## Challenge
Retrieve the flag from this custom transformation obfuscated script (Bonus points for reconstructing the decryption algorithm):
```js
function _0x0d3ffb1e37f793f1(_0xe527dcfbb909ac5e) {
  function _0x0ae033c5d2f1cc82(_0x62c8851a6c0e7d77, _0xdbb71b676d26636c) {
    function _0xc86c18e26d15072e(_0x317bdc452e6129a3, s = []) {
      if (_0x317bdc452e6129a3 >= 256) return s;
      return _0xc86c18e26d15072e((function _0x354887982cc8cb2f() {
        return _0x317bdc452e6129a3 + 1;
      })(), [...s, _0x317bdc452e6129a3]);
    }
    function _0x6ad412ddffe59204(_0x5fd22800de905d37, _0x65d2eea1165e79ee, i = +[], j = 0) {
      if (i >= 256) return _0x5fd22800de905d37;
      const _0x353af41e63f4e16c = _0x65d2eea1165e79ee.length;
      j = (function _0x042a7ca96ed0c8c1() {
        return (j + _0x5fd22800de905d37[i] + _0x65d2eea1165e79ee[i % _0x353af41e63f4e16c]) % 256;
      })();
      [_0x5fd22800de905d37[i], _0x5fd22800de905d37[j]] = [_0x5fd22800de905d37[j], _0x5fd22800de905d37[i]];
      return _0x6ad412ddffe59204(_0x5fd22800de905d37, _0x65d2eea1165e79ee, (function _0xd63231ceed5ac1fa() {
        return i + 1;
      })(), j);
    }
    function _0xe5c09a6f110ee915(_0x7ecea69acc15f853, _0x896414246b54c7bd, _0xfa1ea81bcc1a253c, _0xae68bbba8c8200c7, decrypted = []) {
      if (_0xae68bbba8c8200c7.length === 0) return new Uint8Array(decrypted);
      _0x896414246b54c7bd = (function _0xa42a1de0bcd69258() {
        return (_0x896414246b54c7bd + 2) % 256;
      })();
      _0xfa1ea81bcc1a253c = (function _0x0e5e6e0882941d0d() {
        return (_0xfa1ea81bcc1a253c + _0x7ecea69acc15f853[_0x896414246b54c7bd]) % 256;
      })();
      [_0x7ecea69acc15f853[_0x896414246b54c7bd], _0x7ecea69acc15f853[_0xfa1ea81bcc1a253c]] = [_0x7ecea69acc15f853[_0xfa1ea81bcc1a253c], _0x7ecea69acc15f853[_0x896414246b54c7bd]];
      const _0x8717765a61207050 = _0x7ecea69acc15f853[(function _0x9d205a287b84635c() {
        return (_0x7ecea69acc15f853[_0x896414246b54c7bd] + _0x7ecea69acc15f853[_0xfa1ea81bcc1a253c]) % 256;
      })()];
      const _0xfc1d2fccac9ad42c = _0xae68bbba8c8200c7[0] ^ _0x8717765a61207050;
      return _0xe5c09a6f110ee915(_0x7ecea69acc15f853, _0x896414246b54c7bd, _0xfa1ea81bcc1a253c, _0xae68bbba8c8200c7.slice(1), [...decrypted, _0xfc1d2fccac9ad42c]);
    }
    let _0xa5f9b9899f8dbf4a = typeof _0xdbb71b676d26636c === 'string' ? Array.from(_0xdbb71b676d26636c).map(c => c.charCodeAt(0)) : Array.from(_0xdbb71b676d26636c);
    const _0x76c2d85e5d4d747b = _0xc86c18e26d15072e(0);
    const _0x851f18acd024678b = _0x6ad412ddffe59204([..._0x76c2d85e5d4d747b], _0xa5f9b9899f8dbf4a);
    return _0xe5c09a6f110ee915([..._0x851f18acd024678b], +[], +[], Array.from(_0x62c8851a6c0e7d77));
  }
  const _0x49a4a7744a7aef7e = "xaf8029d291584ec0";
  const _0xcefee6048ddbc616 = _0xe527dcfbb909ac5e.split(/\\x/g).slice(1).map(b => parseInt(b, 16));
  const _0xa5cc4445cfa0268e = new Uint8Array(_0x0ae033c5d2f1cc82(_0xcefee6048ddbc616, _0x49a4a7744a7aef7e));
  return String.fromCharCode(..._0xa5cc4445cfa0268e).replace(/[a-zA-Z]/g, c => String.fromCharCode((c <= 'Z' ? 90 : 122) >= (c = (function _0x7843da26dcf91f54() {
    return c.charCodeAt(0) + 13;
  })()) ? c : (function _0xd86e6e0b651bee32() {
    return c - 26;
  })()));
}
const _0x27b0d031376813b9 = _0x0d3ffb1e37f793f1("\\x03\\x50\\xdd\\x05");
const _0x6c63dbc8f7da2875 = [][_0x0d3ffb1e37f793f1("\\x18\\x40\\xd6\\x07\\x2b\\x57")][_0x0d3ffb1e37f793f1("\\x1b\\x54\\xce\\x06\\x3e\\x57\\xcb\\x43\\xe4\\x7c\\x0a")];
let _0x643a265f5834191d = !0;
let _0xdb20bba6254f9a5d = [+[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[], +_0x0d3ffb1e37f793f1(""), +[]];
function _0x5d54cfc42ea10c98() {
  const _0xf89c72fd2aa2e5af = _0x0d3ffb1e37f793f1("\\x12\\x44\\xce\\x14\\x3e\\x47");
  const _0x0266d14f644e80a6 = _0x0d3ffb1e37f793f1("\\x1b\\x58\\xd6\\x19\\x2b\\x40");
  const _0xe9aecc267830f78f = [(function _0xa5c8309cfdbb51a8() {
    return 34 * 3;
  })(), (function _0x6238be5c54193224() {
    return 12 * 9;
  })(), 97, 103, 123, (function _0xd1518e2d018833de() {
    return 21 * 4;
  })(), (function _0x72662382160a077a() {
    return 42 + 40;
  })(), 52, 78, (function _0x37711b2895ecfb0b() {
    return [arguments[_0x0266d14f644e80a6] + []][+''][_0xf89c72fd2aa2e5af] + 10;
  })(), 70, (function _0xc0649f0a8ced5555() {
    return 97 % 50 + !_0x643a265f5834191d;
  })(), 82, 77, 52, (function _0xc931e87ccf3daa63() {
    return 21 * 4;
  })(), 49, 48, 78, (function _0xd39927b5ace96151() {
    return 9 * 5;
  })(), 49, (function _0xc02acfb577d6285a() {
    return [arguments[_0x0266d14f644e80a6] + []][+''][_0xf89c72fd2aa2e5af] + 10;
  })(), (function _0x93469b0196bdb7bb() {
    return 9 * 5;
  })(), 67, (function _0x4a269032c34c6139() {
    return 97 % 50 + !_0x643a265f5834191d;
  })(), 48, 76, (function _0xd40fc61ae8e58566() {
    return 25 * 5;
  })()];
  let _0x0c1caf24688f1148 = +[];
  const _0xe524ca7afd142db6 = {
    next: () => _0xe9aecc267830f78f[(function _0x6a638f06459bfba6() {
      return _0x0c1caf24688f1148++ % _0xe9aecc267830f78f[_0xf89c72fd2aa2e5af];
    })()]
  };
  _0xdb20bba6254f9a5d = _0xdb20bba6254f9a5d[_0x0d3ffb1e37f793f1("\\x11\\x58\\xcc")](() => _0xe524ca7afd142db6[_0x0d3ffb1e37f793f1("\\x0a\\x44\\xc4\\x07")]());
}
const _0x7c3e93e6ff3c0e10 = () => {
  return _0x5d54cfc42ea10c98();
};
function _0x17b87e030b0680ef() {
  let _0x958427fc2bc65578 = [_0x6c63dbc8f7da2875(_0x0d3ffb1e37f793f1("\\x0e\\x44\\xc8\\x08\\x3c\\x53\\x83\\x5d\\xe6\\x6a\\x07\\xcd\\xa6\\xf7\\x6f\\xee\\x3b\\x34\\xe3\\x4c\\x76\\x91\\xd0\\xcf\\x2f\\x88\\xcd\\xfb\\xb3\\x04\\xef\\x6f\\x0d\\x23\\x87\\x0d\\xb4\\x74\\xbb\\x61"))()];
  _0x643a265f5834191d = !_0x643a265f5834191d;
  if (_0x958427fc2bc65578[+_0x0d3ffb1e37f793f1("")][0] !== _0x0d3ffb1e37f793f1("\\x05\\x47\\xd5\\x16\\x38")) {
    throw new Error(_0x0d3ffb1e37f793f1("\\x27\\x54\\xc7\\x40\\x28\\x50\\x83\\x52\\xe1\\x79\\x4f\\xc2\\xba\\xff\\x7a\\xa8\\x7b\\x34\\xfd\\x47\\x69\\x85\\x82\\x86\\x3d\\xc6\\xd3\\xf7\\xb7\\x07\\xe1\\x64\\x1a\\x31\\x8d\\x1f\\xa3\\x65\\xae\\x26"));
  }
  _0x7c3e93e6ff3c0e10();
}
try {
  console[_0x0d3ffb1e37f793f1("\\x12\\x54\\xdb")](_0x17b87e030b0680ef(_0x27b0d031376813b9));
  _0x6c63dbc8f7da2875(_0x0d3ffb1e37f793f1("\\x0e\\x44\\xc8\\x08\\x3c\\x53\\x83\\x43\\xe1\\x7f\\x09\\xd5\\xad\\xe4"))()[_0x0d3ffb1e37f793f1("\\x12\\x54\\xdb")](_0x0d3ffb1e37f793f1("\\x38\\x4f\\xc1\\x14\\x63"), _0x6c63dbc8f7da2875(_0x0d3ffb1e37f793f1("\\x0e\\x44\\xc8\\x08\\x3c\\x53\\x83\\x75\\xe4\\x7b\\x19\\xd6\\xa0"))()[_0x0d3ffb1e37f793f1("\\x18\\x53\\xcd\\x1a\\x09\\x47\\xcd\\x56\\xd3\\x7c\\x1e\\xc5")](..._0xdb20bba6254f9a5d));
} catch (e) {
  console[_0x0d3ffb1e37f793f1("\\x19\\x53\\xca\\x02\\x3c")](e.message);
}
```